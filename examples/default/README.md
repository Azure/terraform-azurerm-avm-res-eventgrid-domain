<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# Default example

This example deploys an Event Grid Domain with a domain-level event subscription using **fully keyless security** with managed identity. The example demonstrates:

- Creating an Event Grid Domain with **system-assigned managed identity**
- Creating a **keyless storage account** (`allowSharedKeyAccess = false`) using AzAPI provider
- Creating a storage queue using AzAPI (no shared keys required)
- Configuring a domain event subscription using the `domain_event_subscription` submodule with **managed identity delivery**
- Setting up **RBAC role assignment** for Event Grid to access the storage queue
- Configuring event filtering with subject filters and advanced filters
- Setting up retry policies for event delivery
- Using labels for organization

## Security Features

This example follows Azure security best practices with a **fully keyless architecture**:

- ✅ **No Shared Access Keys** - Storage account has `allowSharedKeyAccess = false`
- ✅ **Managed Identity** - Event Grid uses system-assigned managed identity for authentication
- ✅ **RBAC-based Access** - Uses "Storage Queue Data Contributor" role for secure access
- ✅ **Secure Event Delivery** - Events are delivered using `delivery_with_resource_identity`
- ✅ **AzAPI Provider** - Used for storage resources to support keyless deployment

The domain event subscription delivers events to an Azure Storage Queue using managed identity authentication (no keys anywhere), filtered by subject prefix and event type, with custom retry policies.

## Why AzAPI Provider?

The `azurerm_storage_account` and `azurerm_storage_queue` resources require shared key access for Terraform state management. By using the `azapi` provider, we can deploy and manage storage resources without requiring shared key access, achieving a truly keyless infrastructure.

```hcl
terraform {
  required_version = "~> 1.5"

  required_providers {
    azapi = {
      source  = "azure/azapi"
      version = "~> 2.0"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.21"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5"
    }
    time = {
      source  = "hashicorp/time"
      version = "~> 0.9"
    }
  }
}

provider "azurerm" {
  features {}
}


## Section to provide a random Azure region for the resource group
# This allows us to randomize the region for the resource group.
module "regions" {
  source  = "Azure/avm-utl-regions/azurerm"
  version = "0.9.0"
}

# This allows us to randomize the region for the resource group.
resource "random_integer" "region_index" {
  max = length(module.regions.regions) - 1
  min = 0
}
## End of section to provide a random Azure region for the resource group

# This ensures we have unique CAF compliant names for our resources.
module "naming" {
  source  = "Azure/naming/azurerm"
  version = "0.4.2"
}

# This is required for resource modules
resource "azurerm_resource_group" "this" {
  location = module.regions.regions[random_integer.region_index.result].name
  name     = module.naming.resource_group.name_unique
}

# Storage account for event subscription destination (using AzAPI for keyless operation)
resource "azapi_resource" "storage_account" {
  location  = azurerm_resource_group.this.location
  name      = module.naming.storage_account.name_unique
  parent_id = azurerm_resource_group.this.id
  type      = "Microsoft.Storage/storageAccounts@2023-05-01"
  body = {
    kind = "StorageV2"
    sku = {
      name = "Standard_LRS"
    }
    properties = {
      allowSharedKeyAccess = false # Security best practice - no keys
      minimumTlsVersion    = "TLS1_2"
      publicNetworkAccess  = "Enabled"
    }
  }
}

# Storage queue using AzAPI (no shared key required)
resource "azapi_resource" "storage_queue" {
  name      = "eventgridqueue"
  parent_id = "${azapi_resource.storage_account.id}/queueServices/default"
  type      = "Microsoft.Storage/storageAccounts/queueServices/queues@2023-05-01"
  body = {
    properties = {}
  }
}

# This is the module call
# Do not specify location here due to the randomization above.
# Leaving location as `null` will cause the module to use the resource group location
# with a data source.
module "test" {
  source = "../../"

  location         = azurerm_resource_group.this.location
  name             = module.naming.eventgrid_domain.name_unique
  parent_id        = azurerm_resource_group.this.id
  enable_telemetry = var.enable_telemetry # see variables.tf
  # Enable system-assigned managed identity for secure delivery
  managed_identities = {
    system_assigned = true
  }
}

# Grant the Event Grid Domain's managed identity permission to write to the storage queue
resource "azurerm_role_assignment" "eventgrid_storage_queue_sender" {
  principal_id                     = module.test.system_assigned_mi_principal_id
  scope                            = azapi_resource.storage_account.id
  role_definition_name             = "Storage Queue Data Message Sender"
  skip_service_principal_aad_check = true # Skip AAD check to speed up propagation
}

# Wait for RBAC propagation before creating event subscription
resource "time_sleep" "wait_for_rbac" {
  create_duration = "60s"

  depends_on = [
    azurerm_role_assignment.eventgrid_storage_queue_sender
  ]
}

# Example domain event subscription using the submodule with managed identity
module "domain_event_subscription" {
  source = "../../modules/domain_event_subscription"

  event_grid_domain_resource_id = module.test.resource_id
  name                          = "example-domain-subscription"
  # Use managed identity for secure delivery (no shared keys)
  delivery_with_resource_identity = {
    identity = {
      type = "SystemAssigned"
    }
    destination = {
      storage_queue = {
        resource_id                           = azapi_resource.storage_account.id
        queue_name                            = azapi_resource.storage_queue.name
        queue_message_time_to_live_in_seconds = 604800 # 7 days
      }
    }
  }
  event_delivery_schema = "EventGridSchema"
  # Event filtering
  filter = {
    subject_begins_with       = "/myapp/"
    is_subject_case_sensitive = false
    included_event_types      = ["Microsoft.EventGrid.CustomEvent"]
    advanced_filters = [
      {
        key           = "data.severity"
        operator_type = "StringIn"
        values        = ["high", "critical"]
      }
    ]
  }
  # Labels for organization
  labels = ["example", "default"]
  # Retry policy
  retry_policy = {
    max_delivery_attempts         = 30
    event_time_to_live_in_minutes = 1440
  }

  depends_on = [time_sleep.wait_for_rbac]
}
```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (~> 1.5)

- <a name="requirement_azapi"></a> [azapi](#requirement\_azapi) (~> 2.0)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (~> 4.21)

- <a name="requirement_random"></a> [random](#requirement\_random) (~> 3.5)

- <a name="requirement_time"></a> [time](#requirement\_time) (~> 0.9)

## Resources

The following resources are used by this module:

- [azapi_resource.storage_account](https://registry.terraform.io/providers/azure/azapi/latest/docs/resources/resource) (resource)
- [azapi_resource.storage_queue](https://registry.terraform.io/providers/azure/azapi/latest/docs/resources/resource) (resource)
- [azurerm_resource_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [azurerm_role_assignment.eventgrid_storage_queue_sender](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) (resource)
- [random_integer.region_index](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/integer) (resource)
- [time_sleep.wait_for_rbac](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep) (resource)

<!-- markdownlint-disable MD013 -->
## Required Inputs

No required inputs.

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_enable_telemetry"></a> [enable\_telemetry](#input\_enable\_telemetry)

Description: This variable controls whether or not telemetry is enabled for the module.  
For more information see <https://aka.ms/avm/telemetryinfo>.  
If it is set to false, then no telemetry will be collected.

Type: `bool`

Default: `true`

## Outputs

The following outputs are exported:

### <a name="output_domain_event_subscription_id"></a> [domain\_event\_subscription\_id](#output\_domain\_event\_subscription\_id)

Description: The resource ID of the domain event subscription.

### <a name="output_domain_event_subscription_name"></a> [domain\_event\_subscription\_name](#output\_domain\_event\_subscription\_name)

Description: The name of the domain event subscription.

### <a name="output_domain_name"></a> [domain\_name](#output\_domain\_name)

Description: The name of the Event Grid Domain.

### <a name="output_domain_resource_id"></a> [domain\_resource\_id](#output\_domain\_resource\_id)

Description: The resource ID of the Event Grid Domain.

### <a name="output_storage_account_id"></a> [storage\_account\_id](#output\_storage\_account\_id)

Description: The resource ID of the storage account used for event subscription destination.

### <a name="output_storage_queue_name"></a> [storage\_queue\_name](#output\_storage\_queue\_name)

Description: The name of the storage queue used for event subscription destination.

## Modules

The following Modules are called:

### <a name="module_domain_event_subscription"></a> [domain\_event\_subscription](#module\_domain\_event\_subscription)

Source: ../../modules/domain_event_subscription

Version:

### <a name="module_naming"></a> [naming](#module\_naming)

Source: Azure/naming/azurerm

Version: 0.4.2

### <a name="module_regions"></a> [regions](#module\_regions)

Source: Azure/avm-utl-regions/azurerm

Version: 0.9.0

### <a name="module_test"></a> [test](#module\_test)

Source: ../../

Version:

<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoft’s privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.
<!-- END_TF_DOCS -->